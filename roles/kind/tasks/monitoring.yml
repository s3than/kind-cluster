- name: Wait for kube-system to be ready
  k8s_info:
    kind: Pod
    namespace: kube-system
  register: pods_output
  retries: 20
  delay: 45
  until: "pods_output | json_query('resources[*].status.containerStatuses[?ready == `false`][].ready | contains(@, `false`)') != true"

- name: Create a k8s namespace
  k8s:
    name: ca-system
    api_version: v1
    kind: Namespace
    state: present

- name: Install Prometheus Operator
  helm_cli:
    chart_ref: stable/prometheus-operator
    binary_path: helm
    update_repo_cache: true
    chart_version: 8.9.2
    state: present
    namespace: ca-system
    name: ca-prometheus
  until: "pods_output | json_query('resources[*].status.containerStatuses[?ready == `false`][].ready | contains(@, `false`)') != true"

- name: Install Prometheus Adapter
  helm_cli:
    chart_ref: stable/prometheus-adapter
    binary_path: helm
    update_repo_cache: true
    chart_version: 2.1.2
    state: present
    namespace: ca-system
    name: ca-prometheus-adapter
    values:
      logLevel: 4
      prometheus:
        url: http://ca-prometheus-prometheus-o-prometheus
      rules:
        resource:
          cpu:
            containerQuery: sum(rate(container_cpu_usage_seconds_total{<<.LabelMatchers>>}[3m])) by (<<.GroupBy>>)
            nodeQuery: sum(rate(container_cpu_usage_seconds_total{<<.LabelMatchers>>, id='/'}[3m])) by (<<.GroupBy>>)
            resources:
              overrides:
                node:
                  resource: node
                namespace:
                  resource: namespace
                pod:
                  resource: pod
            containerLabel: container
          memory:
            containerQuery: sum(container_memory_working_set_bytes{<<.LabelMatchers>>}) by (<<.GroupBy>>)
            nodeQuery: sum(container_memory_working_set_bytes{<<.LabelMatchers>>,id='/'}) by (<<.GroupBy>>)
            resources:
              overrides:
                node:
                  resource: node
                namespace:
                  resource: namespace
                pod:
                  resource: pod
            containerLabel: container
          window: 3m
